<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n L√Ω B√†i Vi·∫øt</title>
<link rel="stylesheet" href="trangchinh.css">
</head>
<body>

<button class="dark-btn" onclick="toggleDarkMode()">üåô Dark Mode</button>
<a href="trang1.html" class="logout-btn">ƒêƒÉng xu·∫•t</a>

<div class="container">

<!-- ==== PANEL TRUNG T√ÇM (C·ªê ƒê·ªäNH) ==== -->
<div class="panel center-panel panel-fixed">
    <h2>Trung t√¢m n·ªôi dung</h2>
    <div class="stats" id="stats">B√†i c·ªßa b·∫°n: 0 | T·ªïng like: 0 | B√¨nh lu·∫≠n: 0</div>

    <input id="title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt...">
    <textarea id="content" placeholder="Nh·∫≠p n·ªôi dung b√†i vi·∫øt..."></textarea>

    <input id="imageFile" type="file" accept="image/*">

    <select id="type">
        <option value="Tin t·ª©c">Tin t·ª©c</option>
        <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
        <option value="H·ªçc t·∫≠p">H·ªçc t·∫≠p</option>
        <option value="Kh√°c">Kh√°c</option>
    </select>

    <select id="visibility">
        <option value="C√¥ng khai">C√¥ng khai</option>
        <option value="Ri√™ng t∆∞">Ri√™ng t∆∞</option>
    </select>

    <button class="btn-primary" id="addBtn" onclick="addPost()">Th√™m b√†i vi·∫øt</button>
</div>

<!-- PANEL CH·ª®C NƒÇNG (C·ªê ƒê·ªäNH) -->
<div class="panel panel-fixed">
    <h2>Ch·ª©c nƒÉng</h2>

    <input id="search" placeholder="T√¨m ki·∫øm b√†i vi·∫øt..." oninput="renderPosts()">

    <select id="filter" onchange="renderPosts()">
        <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
        <option value="Tin t·ª©c">Tin t·ª©c</option>
        <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
        <option value="H·ªçc t·∫≠p">H·ªçc t·∫≠p</option>
        <option value="Kh√°c">Kh√°c</option>
    </select>

    <button class="btn-danger" onclick="clearAll()">X√≥a to√†n b·ªô b√†i</button>
</div>

<!-- PANEL DANH S√ÅCH B√ÄI VI·∫æT -->
<div class="panel panel-scroll">
    <h2>Danh s√°ch b√†i vi·∫øt</h2>
    <div id="list"></div>
</div>

</div>

<script>
// ======================
// L·∫§Y C√ÅC PH·∫¶N T·ª¨ DOM
// ======================
const titleInput = document.getElementById("title");
const contentInput = document.getElementById("content");
const typeInput = document.getElementById("type");
const visibilityInput = document.getElementById("visibility");
const imageFile = document.getElementById("imageFile");
const searchInput = document.getElementById("search");
const filterInput = document.getElementById("filter");
const addBtn = document.getElementById("addBtn");
const stats = document.getElementById("stats");

// USER ƒëang ƒëƒÉng nh·∫≠p
let loggedUser = localStorage.getItem("loggedUser") || "Tr√¨nh";

// DARK MODE
if(localStorage.getItem("darkMode")==="on") document.body.classList.add("dark");
function toggleDarkMode(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "on" : "off");
}

// ======================
let posts = JSON.parse(localStorage.getItem("posts") || "[]");
let editingIndex = -1;

function save(){ localStorage.setItem("posts", JSON.stringify(posts)); }

// ======================
// TH√äM HO·∫∂C C·∫¨P NH·∫¨T B√ÄI
// ======================
function addPost(){
    const title = titleInput.value.trim();
    const content = contentInput.value.trim();
    const type = typeInput.value;
    const visibility = visibilityInput.value;

    if(!title || !content){
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
    }

    const file = imageFile.files[0];

    if(file){
        const reader = new FileReader();
        reader.onload = e => savePost(title, content, type, visibility, e.target.result);
        reader.readAsDataURL(file);
    } else {
        savePost(title, content, type, visibility, "");
    }
}

function savePost(title, content, type, visibility, image){
    if(editingIndex !== -1){
        let p = posts[editingIndex];
        p.title = title;
        p.content = content;
        p.type = type;
        p.visibility = visibility;
        if(image) p.image = image;
        p.time = new Date().toLocaleString();

        editingIndex = -1;
        addBtn.innerText = "Th√™m b√†i vi·∫øt";
    } else {
        posts.push({
            title, content, type, visibility, image,
            time: new Date().toLocaleString(),
            likes: [],
            comments: [],
            user: loggedUser
        });
    }

    save();
    renderPosts();

    titleInput.value = "";
    contentInput.value = "";
    imageFile.value = "";
}

function editPost(i){
    editingIndex = i;
    let p = posts[i];

    titleInput.value = p.title;
    contentInput.value = p.content;
    typeInput.value = p.type;
    visibilityInput.value = p.visibility;

    addBtn.innerText = "C·∫≠p nh·∫≠t b√†i vi·∫øt";
}

function deletePost(i){
    posts.splice(i,1);
    save();
    renderPosts();
}

function clearAll(){
    if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô b√†i?")){
        posts = posts.filter(p => p.user !== loggedUser);
        save();
        renderPosts();
    }
}

// ======================
// LIKE
// ======================
function toggleLike(i){
    let p = posts[i];

    if(!p.likes.includes(loggedUser)) p.likes.push(loggedUser);
    else p.likes = p.likes.filter(u => u !== loggedUser);

    save();
    renderPosts();
}

// ======================
// B√åNH LU·∫¨N
// ======================
function addComment(i){
    let input = document.getElementById("cmt_"+i);
    let text = input.value.trim();
    if(!text) return;

    posts[i].comments.push({
        user: loggedUser,
        text,
        time: new Date().toLocaleString()
    });

    input.value = "";
    save();
    renderPosts();
}

// ======================
// HI·ªÇN TH·ªä DANH S√ÅCH B√ÄI
// ======================
function renderPosts(){
    const search = searchInput.value.toLowerCase();
    const filter = filterInput.value;
    const list = document.getElementById("list");
    list.innerHTML = "";

    let filtered = posts.filter(p => {
        if(p.visibility === "Ri√™ng t∆∞" && p.user !== loggedUser) return false;
        if(filter !== "T·∫•t c·∫£" && p.type !== filter) return false;

        return (
            p.title.toLowerCase().includes(search) ||
            p.content.toLowerCase().includes(search)
        );
    });

    // TH·ªêNG K√ä RI√äNG CHO USER
    let myPosts = posts.filter(p => p.user === loggedUser);

    stats.innerText =
        `B√†i c·ªßa b·∫°n: ${myPosts.length} | ` +
        `T·ªïng like: ${myPosts.reduce((t,p)=>t+p.likes.length,0)} | ` +
        `B√¨nh lu·∫≠n: ${myPosts.reduce((t,p)=>t+p.comments.length,0)}`;

    // HI·ªÇN TH·ªä B√ÄI
    filtered.forEach((p, index) => {
        let globalIndex = posts.indexOf(p);

        list.innerHTML += `
        <div class="post">
            <span class="post-type">${p.type}</span>
            <b>${p.title}</b> <small>[${p.visibility}]</small>
            <p>${p.content}</p>

            ${p.image ? `<img src="${p.image}">` : ""}

            <small>${p.time} - T√°c gi·∫£: ${p.user}</small><br><br>

            <button class="btn" onclick="toggleLike(${globalIndex})">‚ù§Ô∏è ${p.likes.length} Like</button>

            <div style="margin-top:10px">
                <input id="cmt_${globalIndex}" placeholder="B√¨nh lu·∫≠n..." style="width:80%;padding:8px">
                <button class="btn-primary" onclick="addComment(${globalIndex})">G·ª≠i</button>
            </div>

            <div style="margin-top:10px">
                ${p.comments.map(c => `
                    <div style="background:#eee;padding:8px;border-radius:6px;margin-top:5px">
                        <b>${c.user}:</b> ${c.text}<br>
                        <small>${c.time}</small>
                    </div>
                `).join("")}
            </div>

            <br>
            <button class="btn" onclick="editPost(${globalIndex})">S·ª≠a</button>
            <button class="btn-danger" onclick="deletePost(${globalIndex})">X√≥a</button>
        </div>`;
    });
}

renderPosts();
</script>

</body>
</html>
